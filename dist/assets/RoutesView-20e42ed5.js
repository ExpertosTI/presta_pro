import{e as le,r as m,j as e,M as R,P as ne,a as N,f as x,C as S}from"./index-868a038d.js";const B=le("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["polyline",{points:"22 4 12 14.01 9 11.01",key:"6xbx8j"}]]);function oe({loans:T,clients:j,registerPayment:F,collectors:P,currentRouteLoanIds:C,routeActive:G,toggleLoanInRoute:J,clearCurrentRoute:K,startRoute:U,finishRoute:M,showToast:i,addRouteClosing:z,routeClosings:v,receipts:h,includeFutureInstallments:W}){var Q;const[r,X]=m.useState(""),[O,V]=m.useState(!1),[u,w]=m.useState(null),[$,I]=m.useState(""),[E,H]=m.useState(!1),[y,Z]=m.useState(!1),[_,q]=m.useState(!1),{pendingCollections:ee,sortedRoute:D,totalToCollect:te,selectedStops:A,collectorTodayTotal:se,collectorTodayCount:ae}=m.useMemo(()=>{const t=new Date;t.setHours(0,0,0,0);const l=T.flatMap(n=>{const s=j.find(p=>p.id===n.clientId);if(!s)return[];if(r&&s.collectorId!==r)return[];const c=n.schedule.find(p=>p.status!=="PAID");return c?!W&&new Date(c.date)>t?[]:[{...c,loanId:n.id,clientName:s==null?void 0:s.name,clientAddress:s==null?void 0:s.address,clientPhone:s==null?void 0:s.phone,totalDue:c.payment}]:[]}),a=l.sort((n,s)=>{var c;return((c=n.clientAddress)==null?void 0:c.localeCompare(s.clientAddress||""))||0}),d=a.reduce((n,s)=>n+s.payment,0),f=a.filter(n=>C.includes(`${n.loanId}:${n.id}`));let b=0,g=0;if(r&&Array.isArray(h)){const n=new Date;n.setHours(0,0,0,0);const s=new Date(n);s.setDate(s.getDate()+1),h.forEach(c=>{const p=j.find(k=>k.id===c.clientId);if(!p||p.collectorId!==r)return;const Y=new Date(c.date);if(Y>=n&&Y<s){const k=parseFloat(c.amount||0)||0;b+=k,g+=1}})}return{pendingCollections:l,sortedRoute:a,totalToCollect:d,selectedStops:f,collectorTodayTotal:b,collectorTodayCount:g}},[T,j,r,C,h]),o=m.useMemo(()=>!r||!Array.isArray(v)?null:v.find(t=>t.collectorId===r)||null,[r,v]),L=m.useMemo(()=>{if(!o||!Array.isArray(h))return[];const t=new Date(o.date);t.setHours(0,0,0,0);const l=new Date(t);return l.setDate(l.getDate()+1),h.filter(a=>{const d=j.find(b=>b.id===a.clientId);if(!d||d.collectorId!==o.collectorId)return!1;const f=new Date(a.date);return f>=t&&f<l})},[o,h,j]);return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center bg-indigo-600 text-white p-6 rounded-2xl shadow-lg",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(R,{})," Ruta Inteligente"]}),e.jsx("p",{className:"opacity-80",children:"Optimización de cobros por zona"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-3xl font-bold",children:ee.length}),e.jsx("p",{className:"text-xs uppercase tracking-wider",children:"Paradas Pendientes"})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-600",children:"Filtrar por Cobrador:"}),e.jsxs("select",{className:"p-2 border rounded-lg bg-white text-sm",value:r,onChange:t=>X(t.target.value),children:[e.jsx("option",{value:"",children:"Todos"}),P.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:U,className:"inline-flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md hover:bg-emerald-700",children:[e.jsx(R,{size:16})," ",G?"Ruta en curso":"Iniciar Ruta"]}),e.jsx("button",{type:"button",onClick:()=>{if(!r){i&&i("Selecciona un cobrador para cuadrar la ruta.","error");return}if(!O){V(!0),i&&i("Verifica que el cobrador haya entregado todo el dinero y vuelve a presionar para confirmar el cuadre.","info");return}const t=se||0,l=ae||0,a=new Date().toISOString();z&&z({collectorId:r,date:a,totalAmount:t,receiptsCount:l}),M&&M(),V(!1),i&&i("Ruta cerrada y cuadre del cobrador registrado correctamente.","success")},className:"inline-flex items-center gap-2 bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-semibold shadow-md hover:bg-blue-700",children:O?"Confirmar Cuadre":"Cerrar / Cuadre Cobrador"}),e.jsx("button",{type:"button",onClick:()=>{const t=!!r;if((()=>{if(!t||!Array.isArray(h))return!1;const a=new Date;a.setHours(0,0,0,0);const d=new Date(a);return d.setDate(d.getDate()+1),h.some(f=>{const b=j.find(n=>n.id===f.clientId);if(!b||b.collectorId!==r)return!1;const g=new Date(f.date);return g>=a&&g<d})})()&&!E){H(!0),i&&i("Ya hay cobros registrados hoy para este cobrador. Si solo quieres limpiar la lista de ruta (sin borrar cobros), vuelve a presionar Limpiar Ruta.","info");return}K(),H(!1),i&&i("Ruta limpiada. Los cobros y recibos permanecen registrados.","success")},className:"inline-flex items-center gap-2 bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-xs font-semibold hover:bg-slate-300",children:E?"Confirmar limpiar":"Limpiar Ruta"}),e.jsxs("button",{type:"button",onClick:()=>window.print(),className:"inline-flex items-center gap-2 bg-slate-900 text-white px-3 py-2 rounded-lg text-xs font-semibold shadow-md hover:bg-slate-800",children:[e.jsx(ne,{size:16})," Imprimir"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[D.map((t,l)=>{const a=`${t.loanId}:${t.id}`,d=C.includes(a);return e.jsxs("div",{className:"bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 hover:border-indigo-500 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{className:"bg-indigo-100 text-indigo-700 w-10 h-10 rounded-full flex items-center justify-center font-bold",children:l+1}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-slate-800",children:t.clientName}),e.jsxs("p",{className:"text-sm text-slate-500 flex items-center gap-1",children:[e.jsx(R,{size:14})," ",t.clientAddress]}),e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:["Cuota #",t.number," • Vence: ",N(t.date)]})]})]}),e.jsxs("div",{className:"text-right w-full md:w-auto",children:[e.jsx("button",{type:"button",onClick:()=>J(t.loanId,t.id),className:`mb-1 inline-flex items-center justify-center px-2 py-1 rounded-full text-[11px] font-semibold border ${d?"bg-emerald-50 border-emerald-500 text-emerald-700":"bg-slate-50 border-slate-300 text-slate-500"}`,children:d?"En ruta":"Agregar a ruta"}),e.jsx("p",{className:"font-bold text-lg text-slate-800",children:x(t.payment)}),e.jsxs("button",{onClick:()=>{I(""),w({loanId:t.loanId,installmentId:t.id,amount:t.payment,number:t.number,date:t.date,clientName:t.clientName})},className:"mt-2 w-full bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-green-600 flex items-center justify-center gap-2",children:[e.jsx(B,{size:16})," Cobrar"]})]})]},t.id)}),D.length===0&&e.jsxs("div",{className:"text-center py-12 bg-white rounded-xl border border-dashed border-slate-300",children:[e.jsx(B,{size:48,className:"text-green-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-bold text-slate-700",children:"¡Ruta Completada!"}),e.jsx("p",{className:"text-slate-500",children:"No hay cobros pendientes para hoy."})]})]}),e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs(S,{className:"bg-slate-50 border-slate-200",children:[e.jsx("h3",{className:"font-bold text-slate-800 mb-4",children:"Resumen de Ruta"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Total a Recaudar"}),e.jsx("span",{className:"font-bold text-slate-800",children:x(te)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Clientes Visitados"}),e.jsxs("span",{className:"font-bold text-slate-800",children:["0 / ",D.length]})]})]})]}),e.jsxs(S,{className:"bg-white border-slate-200",children:[e.jsx("h3",{className:"font-bold text-slate-800 mb-2",children:"Ruta en construcción"}),A.length===0?e.jsx("p",{className:"text-xs text-slate-400",children:"Selecciona clientes en la lista para armar la ruta."}):e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsx("ul",{className:"divide-y divide-slate-100 max-h-40 overflow-y-auto",children:A.map(t=>e.jsxs("li",{className:"py-1 flex justify-between",children:[e.jsx("span",{className:"truncate mr-2",children:t.clientName}),e.jsx("span",{className:"font-semibold",children:x(t.payment)})]},t.id))}),e.jsxs("div",{className:"pt-2 border-t border-slate-100 flex justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Total Ruta"}),e.jsx("span",{className:"font-bold",children:x(A.reduce((t,l)=>t+l.payment,0))})]})]})]}),o&&e.jsxs(S,{className:"bg-emerald-50 border-emerald-200",children:[e.jsx("h3",{className:"font-bold text-emerald-800 mb-2 text-sm",children:"Último cuadre del cobrador"}),e.jsxs("p",{className:"text-xs text-emerald-700 mb-1",children:["Fecha: ",N(o.date)]}),e.jsxs("p",{className:"text-xs text-emerald-700 mb-1",children:["Recibos: ",e.jsx("span",{className:"font-bold",children:o.receiptsCount})]}),e.jsxs("p",{className:"text-xs text-emerald-700",children:["Total cobrado: ",e.jsx("span",{className:"font-bold",children:x(o.totalAmount)})]}),e.jsx("button",{type:"button",onClick:()=>q(!0),className:"mt-3 text-[11px] font-semibold text-emerald-800 underline",children:"Ver tickets cobrados"})]})]})]}),_&&o&&e.jsx("div",{className:"fixed inset-0 bg-slate-900/70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"w-full max-w-lg bg-white rounded-2xl shadow-2xl p-6 max-h-[80vh] flex flex-col",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-1",children:"Tickets cobrados en el último cuadre"}),e.jsxs("p",{className:"text-xs text-slate-600 mb-2",children:["Cobrador:"," ",e.jsx("span",{className:"font-semibold",children:((Q=P.find(t=>t.id===o.collectorId))==null?void 0:Q.name)||"Sin nombre"})," ","· Fecha: ",N(o.date)]}),e.jsxs("p",{className:"text-xs text-slate-600 mb-3",children:["Total reportado: ",e.jsx("span",{className:"font-semibold",children:x(o.totalAmount)})," ","· Recibos: ",e.jsx("span",{className:"font-semibold",children:o.receiptsCount})]}),e.jsx("div",{className:"flex-1 overflow-y-auto border border-slate-100 rounded-xl",children:L.length===0?e.jsx("div",{className:"p-4 text-sm text-slate-500 text-center",children:"No se encontraron tickets para este cuadre. Verifica la fecha o el cobrador."}):e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{className:"bg-slate-50 text-slate-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Cliente"}),e.jsx("th",{className:"p-2 text-left",children:"Fecha"}),e.jsx("th",{className:"p-2 text-right",children:"Cuota"}),e.jsx("th",{className:"p-2 text-right",children:"Mora"}),e.jsx("th",{className:"p-2 text-right",children:"Total"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:L.map(t=>{const l=parseFloat(t.amount||0)||0,a=parseFloat(t.penaltyAmount||0)||0,d=l+a;return e.jsxs("tr",{children:[e.jsx("td",{className:"p-2 truncate max-w-[140px]",children:t.clientName}),e.jsx("td",{className:"p-2",children:N(t.date)}),e.jsx("td",{className:"p-2 text-right",children:x(l)}),e.jsx("td",{className:"p-2 text-right text-amber-600",children:x(a)}),e.jsx("td",{className:"p-2 text-right font-semibold text-emerald-700",children:x(d)})]},t.id)})})]})}),e.jsx("button",{type:"button",onClick:()=>q(!1),className:"mt-4 w-full text-xs text-slate-500 hover:text-slate-700",children:"Cerrar"})]})}),u&&e.jsx("div",{className:"fixed inset-0 bg-slate-900/70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-2xl shadow-2xl p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-2",children:"Confirmar cobro de ruta"}),e.jsxs("p",{className:"text-sm text-slate-600 mb-3",children:["Vas a cobrar la cuota",e.jsxs("span",{className:"font-semibold",children:[" #",u.number]})," del cliente",e.jsxs("span",{className:"font-semibold",children:[" ",u.clientName]}),"."]}),e.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[e.jsx("span",{className:"font-semibold",children:"Fecha programada:"})," ",N(u.date)]}),e.jsxs("p",{className:"text-sm text-slate-700 mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Monto de la cuota:"})," ",x(u.amount)]}),y&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-xs font-semibold text-slate-600 mb-1",children:"Monto de mora"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:$,onChange:t=>I(t.target.value),className:"w-full px-3 py-2 rounded-lg border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500",placeholder:"Ej: 50.00"})]}),e.jsx("button",{type:"button",onClick:()=>{const t=!y;Z(t),t||I("")},className:"mb-3 text-xs text-amber-600 hover:text-amber-700 font-semibold",children:y?"Quitar mora":"Agregar mora"}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-2 mt-2",children:e.jsx("button",{onClick:()=>{const t=y&&parseFloat($||"0")||0;t>0?F(u.loanId,u.installmentId,{withPenalty:!0,penaltyAmountOverride:t}):F(u.loanId,u.installmentId),w(null)},className:"flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 rounded-lg",children:"Confirmar pago"})}),e.jsx("button",{onClick:()=>w(null),className:"mt-3 w-full text-xs text-slate-500 hover:text-slate-700",children:"Cancelar"})]})})]})}export{oe as RoutesView,oe as default};
