import{j as e,r as n,C as E,f as d,a as I,b as Q,_ as $}from"./index-868a038d.js";const P=({status:c})=>{const m={ACTIVE:"bg-blue-100 text-blue-800",PAID:"bg-green-100 text-green-800",LATE:"bg-red-100 text-red-800",PENDING:"bg-slate-100 text-slate-800",APPROVED:"bg-teal-100 text-teal-800",REJECTED:"bg-red-50 text-red-600",REVIEW:"bg-yellow-100 text-yellow-800"},h={ACTIVE:"Activo",PAID:"Pagado",LATE:"Atrasado",PENDING:"Pendiente",APPROVED:"Aprobado",REJECTED:"Rechazado",REVIEW:"En revisión"}[c]||c;return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${m[c]||m.PENDING}`,children:h})};function K({loans:c,clients:m,registerPayment:f,selectedLoanId:h,onSelectLoan:D,onUpdateLoan:N}){const[A,S]=n.useState(!1),[k,R]=n.useState(null),[V,y]=n.useState(!1),[o,v]=n.useState(null),[p,z]=n.useState(!1);n.useState(0);const[M,w]=n.useState(""),[F,C]=n.useState(!1),[a,u]=n.useState({amount:"",rate:"",term:"",frequency:"Mensual",startDate:""}),[T,g]=n.useState(""),s=n.useMemo(()=>c.find(t=>t.id===h),[c,h]),i=n.useMemo(()=>s?m.find(t=>t.id===s.clientId):null,[s,m]),x=n.useMemo(()=>!s||!s.schedule?null:s.schedule.find(t=>t.status!=="PAID"),[s]),G=()=>{!s||!N||Array.isArray(s.schedule)&&s.schedule.some(l=>l.status==="PAID")||(u({amount:String(s.amount||""),rate:String(s.rate||""),term:String(s.term||""),frequency:s.frequency||"Mensual",startDate:s.startDate||new Date().toISOString().split("T")[0]}),g(""),C(!0))},_=t=>{if(t.preventDefault(),!s||!N)return;const l=parseFloat(a.amount||"0"),r=parseFloat(a.rate||"0"),b=parseInt(a.term||"0",10);if(!l||!r||!b){g("Completa monto, tasa y plazo con valores válidos.");return}try{const j=Q(l,r,b,a.frequency,a.startDate||s.startDate),O={...s,amount:l,rate:r,term:b,frequency:a.frequency,startDate:a.startDate||s.startDate,schedule:j,totalInterest:j.reduce((L,J)=>L+J.interest,0),totalPaid:0,status:"ACTIVE"};N(O),C(!1)}catch(j){console.error(j),g("No se pudo recalcular la hoja de amortización. Revisa los datos.")}},q=async()=>{if(!(!s||!i)){S(!0);try{const t="AIzaSyA5MERx4fEbc6ekvjRkIQtciJFmhezf2xM",{generateLoanContract:l}=await $(()=>import("./aiService-920c2bbd.js"),[]),r=await l(s,i,"Presta Pro",t);R(r),y(!0)}catch(t){console.error(t),alert("Error generando el contrato. Verifica la configuración de la API Key.")}finally{S(!1)}}};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[V&&e.jsx("div",{className:"fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl",children:[e.jsx("h3",{className:"font-bold text-lg",children:"Contrato Generado por IA"}),e.jsx("button",{onClick:()=>y(!1),className:"text-slate-500 hover:text-slate-800 font-bold text-xl",children:"×"})]}),e.jsx("div",{className:"p-6 overflow-y-auto flex-1 font-mono text-sm whitespace-pre-wrap bg-slate-50",children:k}),e.jsxs("div",{className:"p-4 border-t flex gap-3 justify-end bg-white rounded-b-2xl",children:[e.jsx("button",{onClick:()=>{const t=new Blob([k],{type:"text/plain"}),l=URL.createObjectURL(t),r=document.createElement("a");r.href=l,r.download=`Contrato_${i.name.replace(/\s+/g,"_")}.txt`,r.click()},className:"bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700",children:"Descargar .TXT"}),e.jsx("button",{onClick:()=>window.print(),className:"bg-slate-800 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-900",children:"Imprimir"}),e.jsx("button",{onClick:()=>y(!1),className:"bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-bold hover:bg-slate-300",children:"Cerrar"})]})]})}),F&&s&&e.jsx("div",{className:"fixed inset-0 bg-slate-900/70 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-2xl shadow-2xl p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-1",children:"Editar préstamo"}),e.jsx("p",{className:"text-xs text-slate-500 mb-3",children:"Solo puedes editar préstamos que aún no tengan pagos registrados."}),T&&e.jsx("p",{className:"mb-2 text-xs text-red-600 bg-red-50 border border-red-200 rounded-lg px-3 py-2",children:T}),e.jsxs("form",{onSubmit:_,className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-slate-600 mb-1",children:"Monto"}),e.jsx("input",{type:"number",min:"1",className:"w-full p-2 border rounded-lg",value:a.amount,onChange:t=>u({...a,amount:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-slate-600 mb-1",children:"Tasa %"}),e.jsx("input",{type:"number",min:"0",step:"0.1",className:"w-full p-2 border rounded-lg",value:a.rate,onChange:t=>u({...a,rate:t.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-slate-600 mb-1",children:"Plazo"}),e.jsx("input",{type:"number",min:"1",className:"w-full p-2 border rounded-lg",value:a.term,onChange:t=>u({...a,term:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-slate-600 mb-1",children:"Frecuencia"}),e.jsxs("select",{className:"w-full p-2 border rounded-lg",value:a.frequency,onChange:t=>u({...a,frequency:t.target.value}),children:[e.jsx("option",{children:"Diario"}),e.jsx("option",{children:"Semanal"}),e.jsx("option",{children:"Quincenal"}),e.jsx("option",{children:"Mensual"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-slate-600 mb-1",children:"Fecha de inicio"}),e.jsx("input",{type:"date",className:"w-full p-2 border rounded-lg",value:a.startDate,onChange:t=>u({...a,startDate:t.target.value})})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:()=>{C(!1),g("")},className:"px-4 py-2 rounded-lg bg-slate-100 text-slate-700",children:"Cancelar"}),e.jsx("button",{type:"submit",className:"px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold",children:"Guardar cambios"})]})]})]})}),e.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"Préstamos y Cobros"}),e.jsx(E,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-50 text-slate-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Cliente"}),e.jsx("th",{className:"p-2 text-left",children:"Monto"}),e.jsx("th",{className:"p-2 text-left",children:"Tasa"}),e.jsx("th",{className:"p-2 text-left",children:"Estado"})]})}),e.jsxs("tbody",{className:"divide-y divide-slate-100",children:[c.map(t=>{const l=m.find(b=>b.id===t.clientId),r=h===t.id;return e.jsxs("tr",{onClick:()=>D&&D(t.id),className:`cursor-pointer ${r?"bg-blue-50":"hover:bg-slate-50"}`,children:[e.jsx("td",{className:"p-2",children:(l==null?void 0:l.name)||"Sin cliente"}),e.jsx("td",{className:"p-2",children:d(t.amount)}),e.jsxs("td",{className:"p-2",children:[t.rate,"%"]}),e.jsx("td",{className:"p-2",children:e.jsx(P,{status:t.status})})]},t.id)}),c.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-4 text-center text-slate-400",colSpan:4,children:"No hay préstamos registrados."})}),o&&e.jsx("div",{className:"fixed inset-0 bg-slate-900/70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-2xl shadow-2xl p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-2",children:"Confirmar pago"}),e.jsxs("p",{className:"text-sm text-slate-600 mb-3",children:["Vas a registrar el pago de la cuota",e.jsxs("span",{className:"font-semibold",children:[" #",o.number]})," del cliente",e.jsxs("span",{className:"font-semibold",children:[" ",o.clientName]}),"."]}),e.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[e.jsx("span",{className:"font-semibold",children:"Fecha programada:"})," ",I(o.date)]}),e.jsxs("p",{className:"text-sm text-slate-700 mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Monto de la cuota:"})," ",d(o.amount)]}),p&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-xs font-semibold text-slate-600 mb-1",children:"Monto de mora"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:M,onChange:t=>w(t.target.value),className:"w-full px-3 py-2 rounded-lg border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500",placeholder:"Ej: 50.00"})]}),e.jsx("button",{type:"button",onClick:()=>{const t=!p;z(t),t||w("")},className:"mb-3 text-xs text-amber-600 hover:text-amber-700 font-semibold",children:p?"Quitar mora":"Agregar mora"}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-2 mt-2",children:e.jsx("button",{onClick:()=>{const t=p&&parseFloat(M||"0")||0;t>0?f(o.loanId,o.installmentId,{withPenalty:!0,penaltyAmountOverride:t}):f(o.loanId,o.installmentId),v(null)},className:"flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 rounded-lg",children:"Confirmar pago"})}),e.jsx("button",{onClick:()=>v(null),className:"mt-3 w-full text-xs text-slate-500 hover:text-slate-700",children:"Cancelar"})]})})]})]})})}),s&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(E,{className:"lg:col-span-1",children:[e.jsx("h3",{className:"font-bold text-lg mb-3",children:"Detalle del Préstamo"}),i&&e.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[e.jsx("span",{className:"font-semibold",children:"Cliente: "}),i.name]}),e.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[e.jsx("span",{className:"font-semibold",children:"Monto: "}),d(s.amount)]}),e.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[e.jsx("span",{className:"font-semibold",children:"Tasa: "}),s.rate,"%"]}),e.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[e.jsx("span",{className:"font-semibold",children:"Estado: "}),e.jsx(P,{status:s.status})]}),e.jsxs("p",{className:"text-sm text-slate-700 mb-1",children:[e.jsx("span",{className:"font-semibold",children:"Total Pagado: "}),d(s.totalPaid||0)]}),Array.isArray(s.schedule)&&s.schedule.some(t=>t.status==="PAID")?e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Este préstamo ya tiene pagos registrados y no se puede editar."}):e.jsx("div",{className:"mt-3",children:e.jsx("button",{type:"button",onClick:G,className:"w-full bg-slate-900 text-white py-2 rounded-lg font-bold text-sm hover:bg-slate-800",children:"Editar préstamo"})}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{onClick:q,disabled:A,className:"w-full bg-indigo-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-indigo-700 disabled:opacity-50 flex justify-center items-center gap-2",children:A?"Generando...":"Generar Contrato Legal (IA)"})}),x&&e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 border border-blue-100 rounded-lg text-sm",children:[e.jsx("p",{className:"font-semibold text-blue-800 mb-1",children:"Próxima cuota pendiente"}),e.jsxs("p",{className:"text-slate-700 mb-1",children:[e.jsxs("span",{className:"font-semibold",children:["Cuota #",x.number]})," • ",I(x.date)]}),e.jsxs("p",{className:"text-slate-700 mb-2",children:[e.jsx("span",{className:"font-semibold",children:"Monto: "}),d(x.payment)]}),e.jsx("button",{onClick:()=>{w(""),v({loanId:s.id,installmentId:x.id,amount:x.payment,number:x.number,date:x.date,clientName:(i==null?void 0:i.name)||"Sin cliente"})},className:"w-full bg-green-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-green-700",children:"Registrar Pago de esta Cuota"})]})]}),e.jsxs(E,{className:"lg:col-span-2",children:[e.jsx("h3",{className:"font-bold text-lg mb-3",children:"Hoja de amortización"}),e.jsx("div",{className:"overflow-x-auto max-h-[360px]",children:e.jsxs("table",{className:"w-full text-xs md:text-sm",children:[e.jsx("thead",{className:"bg-slate-50 text-slate-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"#"}),e.jsx("th",{className:"p-2 text-left",children:"Fecha"}),e.jsx("th",{className:"p-2 text-right",children:"Cuota"}),e.jsx("th",{className:"p-2 text-right",children:"Interés"}),e.jsx("th",{className:"p-2 text-right",children:"Capital"}),e.jsx("th",{className:"p-2 text-right",children:"Saldo"}),e.jsx("th",{className:"p-2 text-right",children:"Estado"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:s.schedule.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"p-2",children:t.number}),e.jsx("td",{className:"p-2",children:I(t.date)}),e.jsx("td",{className:"p-2 text-right",children:d(t.payment)}),e.jsx("td",{className:"p-2 text-right text-red-500",children:d(t.interest??0)}),e.jsx("td",{className:"p-2 text-right text-green-600",children:d(t.principal??0)}),e.jsx("td",{className:"p-2 text-right text-slate-500",children:d(t.balance??0)}),e.jsx("td",{className:"p-2 text-right",children:e.jsx(P,{status:t.status==="PAID"?"PAID":"PENDING"})})]},t.id))})]})})]})]})]})}export{K as LoansView,K as default};
